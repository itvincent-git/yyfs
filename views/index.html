<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>贴纸条</title>
<link type="text/css" rel="stylesheet" href="../css/jScrollPane.css" />
<link rel="stylesheet" href="../css/tip-yellow/tip-yellow.css" type="text/css" />
<link rel="stylesheet" href="../css/tip-yellowsimple/tip-yellowsimple.css" type="text/css" />
<link type="text/css" rel="stylesheet" href="../js/jBox/Skins/Brown/jbox.css"/>
<style type="text/css">
body {margin:0 auto; padding:0;text-decoration: none; font-size:12px;font-family:Arial,Verdana, Helvetica, sans-serif; color:#5c4625;background:#deceb4;}
*{ margin: 0; padding: 0; }
a{ outline:none; text-decoration:none;}

h1, h2, h3, h4{ margin: 0; padding:0; font-size:18px;}
img{ border:none;-ms-interpolation-mode: bicubic; }
ul,li,dl,dt,dd,form{ margin:0; padding:0; list-style:none;}

.clear { clear:both; float:none; height:1px; overflow:hidden;} 
.clearfix { height:0;clear:both;float:none;overflow:hidden;width:100%;}

.wrap{ width:100%; height:100%; background:url(../images/body_bg.gif) repeat-x #deceb4;}
.banner{ background:url(../images/banner.jpg) no-repeat; width:768px; height:90px; margin:0 auto;}
.help{position:absolute; top:-90px; right:70px;}
.help .icon{background:url(../images/help.gif) no-repeat; width:46px; height:44px; display:block;}
.help .help_tips{background:url(../images/help_tips.png) no-repeat!important; background:none;
    filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../images/help_tips.png' ,sizingMethod='crop'); width:275px; height:70px; position:absolute; left:-160px; display:none;}

.content{ width:768px;margin:0 auto; padding:15px 0 0 0; position:relative; }
.main{font-family:"微软雅黑" ; width:768px; height:100%; overflow:hidden;}

.content .item{position: relative;word-wrap: break-word; word-break: break-all;background:url(../images/sticker_bg.png) no-repeat!important; background:none;
filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../images/sticker_bg.png' ,sizingMethod='crop'); width:68px; height:52px; padding:20px 10px;text-align:center; overflow:hidden; float:left; display:inline; margin:0 5px 10px 8px;}
.content .big{background:url(../images/sticker_bg_big.png) no-repeat!important; background:none;
filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../images/sticker_bg_big.png' ,sizingMethod='crop'); width:119px; height:96px; padding:25px 20px 25px 10px;}

/*滚动条*/
.content .jScrollPaneDrag {background:url(../images/drag_middle.gif) repeat-y;}
.content .jScrollPaneDragTop {background:url(../images/drag_top.gif) no-repeat;height:10px;}
.content .jScrollPaneDragBottom {background:url(../images/drag_bottom.gif) no-repeat;height:10px;}

.content .jScrollPaneDragHover{background:url(../images/drag_middle.gif) repeat-y;}
.content .jScrollPaneDragTopHover{background:url(../images/drag_top.gif) no-repeat;height:10px;}
.content .jScrollPaneDragBottomHover{background:url(../images/drag_bottom.gif) no-repeat;height:10px;}

.tips{ position:absolute; left:0; top:0; border:1px #b89d73 solid; background:#d4bc96; width:110px; padding:5px; height:auto; color:#6b5025; z-index:999; line-height:18px;}
.tips .arrow{ position:absolute; left:14px; top:-7px; display:block;background:url(../images/arrow.gif) no-repeat; width:11px; height:7px;}
.tips .name{ color:#936112;}

.edit_con{ font-size:14px; padding:50px 20px 0 35px;display: none}
.edit_con ul{ margin-bottom:20px;}
.edit_con li{ float:left; display:inline;}
.edit_con .name{ color:#7d5c22;}
.edit_con .word{ background:url(../images/word_bg.jpg) no-repeat; width:296px; height:80px; padding:14px 20px 10px 30px; overflow:hidden; border:none; resize:none;}
.edit_con .btn_con{ padding-left:95px;}
.edit_con .submit{ display:block; width:114px; height:35px; overflow:hidden;background:url(../images/btn.gif) scroll 0 0 no-repeat; }
.edit_con a.submit:hover{background:url(../images/btn.gif) scroll 0 -35px no-repeat; }

.content .delete{ position:absolute; display:block; top:12px; right:12px; background:url(../images/delete_icon.gif) no-repeat; width:13px; height:14px;}
.content .big .delete{top:17px; right:17px; }
</style>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../js/jquery.mousewheel.js"></script>
<script type="text/javascript" src="../js/jScrollPane.js"></script>
<script type="text/javascript" src="../js/jquery.poshytip.min.js"></script>
<script type="text/javascript" src="../js/yyapi-1.1.js"></script>
<script type="text/javascript" src="../js/jBox/jquery.jBox-2.3.min.js"></script>
<script type="text/javascript" src="../js/jBox/i18n/jquery.jBox-zh-CN.js"></script>
<script type="text/javascript">
var move, cid, currentUser, isManager = false, targetUser;
$(function(){
	var tips = $('.tips');

    try{
        currentUser = yy.user.getCurrentUserInfo();

        //manager
        if(currentUser.role >= 150){
            yy.channel.userListPopMenu.setPopMenu('贴纸条');
            yy.channel.userListPopMenu.addEventListener(IYYChannelUserListPopMenu.CLICKED,onClicked);
            yy.channel.appMsg.addEventListener(IYYChannelAppMsg.APP_LINK_CLICKED,onLinkClicked);
            isManager = true;
        }
        cid = yy.channel.getCurrentChannelInfo().longId;
    }catch(e){
        //test
        cid = 12089499;
    }

    listSticker();

	function onClicked(eventData)
	{
        targetUser = yy.user.getUserInfo(eventData.uid);
		$('.name').text(targetUser.name);
        //show edit page
        $('.edit_con').show();
        $('.item').hide();
	}

    function onLinkClicked(eventData)
    {
        if(eventData.token == 1){
            listSticker();
        }
    }


	$(".main").delegate('.delete', 'click', function(e){
		var stickerId = $(this).attr('stickerId');
        $.jBox.confirm("是否确认撕掉纸条？", "操作提示",function (v, h, f) {
            if (v == 'ok'){
                $.jBox.tip("正在删除数据...", 'loading');
                $.ajax({dataType : 'json', type : 'POST', url : '/delete', data : {
                    cid : cid,
                    stickerId : stickerId
                }, cache : false, timeout : 10000, contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    success : function(data){
                        if(data.result == 0){
                            $.jBox.tip('已撕掉', 'info');
                            listSticker();
                        }else{
                            $.jBox.tip('服务器出错');
                        }
                    }
                    ,error : function(){
                        $.jBox.tip('服务器出错');
                    }
                });

            }
            return true; //close
        });


	});

    //create sticker
    $('.submit').click(function(){
        var content = $('.word').val();
        try{
            var src_nick = currentUser.name;
        }catch(e){
            var src_nick = '--';
        }
        $.ajax({dataType : 'json', type : 'POST', url : '/create', data : {
            content : content,
            cid : cid,
            src_nick : src_nick,
            tar_nick : $('.name').text()

        }, cache : false, timeout : 10000, contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            success : function(data){
                if(data.result == 0){
                    $('.edit_con').hide();
                    listSticker();
                    try{
                        //send message to the target user
                        yy.channel.appMsg.sendMsgToUsers([targetUser.uid], "被偷偷的贴了一张纸条", 0, 9, 1);
                    }catch(e){

                    }
                }else{
                    $.jBox.error('服务器出错');
                }
            }
            ,error : function(){
                $.jBox.error('服务器出错');
            }
        });
    });
});

function listSticker(){
    $.ajax({dataType : 'json', type : 'POST', url : '/list', data : {cid : cid }, cache : false, timeout : 10000, contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        success : function(data){
            //console.dir(data);
            var s = [];
            for(var i = 0; i < data.length; i++){
                s.push('<div class="item big" title="', data[i].src_nick + '&nbsp;给&nbsp;',
                    data[i].tar_nick+ '&nbsp;贴的纸条">',
                    isManager ? '<a href="#" class="delete" stickerId="'+ data[i].id + '"></a>' : '',
                    data[i].content, '</div>');
            }
            $('.list').html(s.join(''));
            $('.main').jScrollPane({showArrows:false, scrollbarWidth:10, arrowSize:0});
            $('.item').each(function(index){
                fixFont(this);
            });
            $('.item').poshytip({
                //  alignTo: 'target',
                className: 'tip-yellowsimple',
                alignX: 'center',
                alignY: 'bottom'
                //followCursor: true,
                //slide: false
            });
        }
    });
}

function fixFont(divObj){
	var fontw=12;//parseInt(divObj.style.fontSize);
	var fonth=fontw+2;//初始字体高度
	var width=119;//str.offsetWidth DIV的宽度
	var height=96;//divObj.offsetHeight;//div的高度
	var lenstr=getLength($(divObj).text());//DIV里文字长度
	// console.debug(lenstr);
	fonts=fontw*fonth*lenstr;//字体面积
	divs=width*height;//DIV面积
	//console.debug(fontw + ',' + fonth + ',' + lenstr+ ',' + fonts + ',' + divs);
	if(fonts>divs)
	{
		var rfont;//重设字体大小为rfont
		//rfont=Math.round((Math.sqrt(4*lenstr*divs-4*lenstr*lenstr)-2*lenstr)/(2*lenstr))-0.1;
		rfont=Math.round((Math.sqrt(4*lenstr*divs-4*lenstr*lenstr)-2*lenstr)/(2*lenstr));
		divObj.style.fontSize=rfont+"px";
	}else{
		var rfont;//重设字体大小为rfont
		rfont=Math.round((Math.sqrt(4*lenstr*divs-4*lenstr*lenstr)-2*lenstr)/(2*lenstr));
		// console.debug(rfont);
		divObj.style.fontSize=rfont+"px";
	}
}

function getLength(str) { 
    var len = str.length; 
    var reLen = 0; 
    for (var i = 0; i < len; i++) {        
        if (str.charCodeAt(i) < 27 || str.charCodeAt(i) > 126) {
            // 全角    
            reLen += 2; 
        } else { 
            reLen++; 
        } 
    } 
    return reLen;    
}
</script>
</head>

<body>
<div class="wrap">
    <div class="banner"></div>
	<div class="content">
        <div class="help" onmouseover="document.getElementById('help_tips').style.display='block'" onmouseout="document.getElementById('help_tips').style.display='none'">
            <a class="icon" href="javascript:;"></a>
            <div class="help_tips" id="help_tips"></div>
        </div>
		<div class="main" id="main">
            <div class="list"></div>
            <div class="edit_con">
                <ul class="con">
                    <li>你想贴的人：</li>
                    <li><span class="name"></span></li>
                    <div class="clearfix"></div>
                </ul>
                <ul>
                    <li style="margin-top:10px;">你想说的话：</li>
                    <li><textarea class="word"></textarea></li>
                    <div class="clearfix"></div>
                </ul>
                <p class="btn_con"><a href="#" class="submit"></a></p>
            </div>
		</div>
	</div>
</div>

</body>
</html>